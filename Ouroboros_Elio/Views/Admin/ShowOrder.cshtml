@model List<BusinessLogicLayer.Dtos.OrderDtos.OrderViewModel>

@{
    Layout = "~/Views/Shared/_LayoutAdmin.cshtml";
}

<main class="main-content position-relative max-height-vh-100 h-100 border-radius-lg">
    <!-- Navbar -->
    <nav class="navbar navbar-main navbar-expand-lg px-0 mx-3 shadow-none border-radius-xl"
         id="navbarBlur"
         data-scroll="true">
        <div class="container-fluid py-1 px-3">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb bg-transparent mb-0 pb-0 pt-1 px-0 me-sm-6 me-5">
                    <li class="breadcrumb-item text-sm">
                        <a class="opacity-5 text-dark" href="javascript:;">Admin</a>
                    </li>
                    <li class="breadcrumb-item text-sm text-dark active"
                        aria-current="page">
                        Orders
                    </li>
                </ol>
            </nav>
            <div class="collapse navbar-collapse mt-sm-0 mt-2 me-md-0 me-sm-4"
                 id="navbar">
                
            </div>
        </div>
    </nav>
    <!-- End Navbar -->
    <div class="container-fluid py-2">
        <div class="row">
            <div class="col-12">
                <div class="card my-4">
                    <div class="card-header p-0 position-relative mt-n4 mx-3 z-index-2">
                        <div class="bg-gradient-dark shadow-dark border-radius-lg pt-4 pb-3">
                            <h6 class="text-white text-capitalize ps-3">Quản lí hóa đơn</h6>
                        </div>
                    </div>
                    <div class="card-body px-0 pb-2">
                        <div class="table-responsive p-0">
                            <table class="table align-items-center mb-0">
                                <thead>
                                    <tr>
                                        <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">
                                            UserName
                                        </th>
                                        <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">
                                            TotalAmount
                                        </th>
                                        <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">
                                            Address
                                        </th>
                                        <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">
                                            Status
                                        </th>
                                        <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">
                                            OrderDate
                                        </th>
                                        <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">
                                            Shipping Code
                                        </th>
                                        <th class="text-secondary opacity-7"></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @if (Model != null && Model.Any())
                                    {
                                        foreach (var item in Model)
                                        {

                                            <tr data-order-id="@item.OrderId">
                                                <td>
                                                    <div class="d-flex px-2 py-1">
                                                        <div class="d-flex flex-column justify-content-center">
                                                            <h6 class="mb-0 text-sm">@item.User.UserName</h6>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td>
                                                    <p class="text-xs font-weight-bold mb-0">VND</p>
                                                    <p class="text-xs text-secondary mb-0">
                                                        @(item.TotalAmount.HasValue? item.TotalAmount.Value.ToString("N0") : "0") ₫
                                                    </p>
                                                </td>
                                                <td class="align-middle text-center">
                                                    <span class="text-secondary text-xs font-weight-bold shipping-address">@item.ShippingAddress</span>
                                                </td>
                                                @if (item.Status != "Chưa giao hàng")
                                                {
                                                    <td class="align-middle text-center text-sm">
                                                        <span class="badge badge-sm bg-gradient-success">@item.Status</span>
                                                    </td>
                                                }
                                                else
                                                {
                                                    <td class="align-middle text-center text-sm">
                                                        <span class="badge badge-sm bg-gradient-secondary">@item.Status</span>
                                                    </td>
                                                }
                                        <td class="align-middle text-center">
                                            <span class="text-secondary text-xs font-weight-bold">
                                                @(
                                                                                                item.OrderDate.HasValue
                                                                                                ? item.OrderDate.Value.ToString("dd/MM/yyyy")
                                                                                                : ""
                                                                                                )
                                            </span>
                                        </td>
                                        <td class="align-middle text-center">
                                            <span class="text-secondary text-xs font-weight-bold">@(string.IsNullOrEmpty(item.CodeShipping) ? "N/A" : item.CodeShipping)</span>
                                        </td>
                                        <td class="align-middle">
                                            <a asp-area="" asp-controller="Admin" asp-action="ShowOrderDetail" asp-route-orderId="@item.OrderId"
                                               class="text-secondary font-weight-bold text-xs me-2 view-btn"
                                               data-toggle="tooltip"
                                               data-original-title="View order"
                                               @* data-bs-toggle="modal"
                                               data-bs-target="#viewModal" *@>
                                                        View
                                                    </a>
                                                    <a href="javascript:;"
                                                       class="text-secondary font-weight-bold text-xs edit-btn"
                                                       data-toggle="tooltip"
                                                       data-original-title="Edit shipping code"
                                                       data-bs-toggle="modal"
                                                       data-bs-target="#editModal">
                                                        Edit
                                                    </a>
                                                </td>
                                            </tr>
                                                                        }
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-lg-12">
                            <div class="hiraola-paginatoin-area">
                                <div class="row">
                                    <div class="col-lg-6 col-md-6 col-sm-6">
                                        <ul class="hiraola-pagination-box">
                                            @* @if (ViewBag.Page > 1)
                                            {
                                                <li>
                                                    <a asp-area="" asp-controller="Admin" asp-action="ShowOrder"
                                                       asp-route-page="@(ViewBag.Page - 1)"
                                                       asp-route-pageSize="@ViewBag.PageSize">
                                                        <i class="ion-ios-arrow-left"></i>
                                                    </a>
                                                </li>
                                            } *@
                                            @for (int i = 1; i <= ViewBag.TotalPages; i++)
                                            {
                                                <li class="@(i == ViewBag.Page ? "active" : "")">
                                                    <a asp-area="" asp-controller="Admin" asp-action="ShowOrder"
                                                       asp-route-page="@i"
                                                       asp-route-pageSize="@ViewBag.PageSize">@i</a>
                                                </li>
                                            }
                                            @* @if (ViewBag.Page < ViewBag.TotalPages)
                                            {
                                                <li>
                                                    <a asp-area="" asp-controller="Admin" asp-action="ShowOrder"
                                                       asp-route-page="@(ViewBag.Page + 1)"
                                                       asp-route-pageSize="@ViewBag.PageSize">
                                                        <i class="ion-ios-arrow-right"></i>
                                                    </a>
                                                </li>
                                            } *@
                                        </ul>
                                    </div>
                                    <div class="col-lg-6 col-md-6 col-sm-6">
                                        <div class="product-select-box">
                                            <div class="product-short">
                                                <p>(@(ViewBag.PageSize * (ViewBag.Page - 1) + 1) - @(Math.Min(ViewBag.PageSize * ViewBag.Page, ViewBag.TotalCount))) - (@ViewBag.TotalPages Trang)</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <footer class="footer py-4  ">
            <div class="container-fluid">
                <div class="row align-items-center justify-content-lg-between">
                    <div class="col-lg-6 mb-lg-0 mb-4">
                        <div class="copyright text-center text-sm text-muted text-lg-start">
                            © <script>
                                  document.write(new Date().getFullYear())
                            </script>,
                            made with <i class="fa fa-heart"></i> by
                            <a href="https://www.creative-tim.com" class="font-weight-bold" target="_blank">Ouroboros Team</a>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <ul class="nav nav-footer justify-content-center justify-content-lg-end">
                            @* <li class="nav-item">
                                    <a href="https://www.creative-tim.com" class="nav-link text-muted" target="_blank">Creative Tim</a>
                                </li>
                                <li class="nav-item">
                                    <a href="https://www.creative-tim.com/presentation" class="nav-link text-muted" target="_blank">About Us</a>
                                </li> *@
                            <li class="nav-item">
                                <a href="https://www.facebook.com/profile.php?id=61577049781454" class="nav-link text-muted" target="_blank">Facebook</a>
                            </li>
                            @* <li class="nav-item">
                                    <a href="https://www.creative-tim.com/license" class="nav-link pe-0 text-muted" target="_blank">License</a>
                                </li> *@
                        </ul>
                    </div>
                </div>
            </div>
        </footer>
    </div>
</main>

<!-- Edit Modal -->
<div class="modal fade"
     id="editModal"
     tabindex="-1"
     aria-labelledby="editModalLabel"
     aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editModalLabel">Edit Shipping Code</h5>
                <button type="button"
                        class="btn-close"
                        data-bs-dismiss="modal"
                        aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="shipping-code-input" class="form-label">Shipping Code</label>
                    <input type="text"
                           class="form-control"
                           id="shipping-code-input"
                           placeholder="Enter new shipping code" />
                </div>
            </div>
            <div class="modal-footer">
                <button type="button"
                        class="btn btn-secondary"
                        data-bs-dismiss="modal">
                    Cancel
                </button>
                <button type="button"
                        class="btn btn-primary"
                        id="save-shipping-code">
                    Save
                </button>
            </div>
        </div>
    </div>
</div>

<style>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet" >
    /* Container pagination */
    .hiraola-pagination-box {
        list-style: none;
        display: flex;
        gap: 8px;
        padding: 0;
        margin: 0;
    }

        /* Các mục trong phân trang */
        .hiraola-pagination-box li {
            display: inline-block;
        }

            /* Link phân trang */
            .hiraola-pagination-box li a {
                display: inline-block;
                padding: 8px 14px;
                font-size: 14px;
                font-weight: 600;
                color: #555555;
                background-color: #f5f5f5;
                border-radius: 6px;
                text-decoration: none;
                transition: background-color 0.3s, color 0.3s;
                border: 1px solid transparent;
                cursor: pointer;
            }

                /* Hover effect */
                .hiraola-pagination-box li a:hover {
                    background-color: #0d6efd; /* màu xanh bootstrap */
                    color: #fff;
                    border-color: #0d6efd;
                }

            /* Trang hiện tại active */
            .hiraola-pagination-box li.active a {
                background-color: #0d6efd;
                color: white;
                border-color: #0d6efd;
                cursor: default;
            }

            /* Disable link nếu muốn (vd cho nút trước/trang trước nếu không thể nhấn) */
            .hiraola-pagination-box li.disabled a {
                color: #aaa;
                cursor: not-allowed;
                background-color: #eee;
                border-color: #ddd;
                pointer-events: none;
            }

            /* Icon mũi tên nhỏ trong nút */
            .hiraola-pagination-box li a i {
                font-size: 16px;
                vertical-align: middle;
            }

    .shipping-address {
        max-width: 220px; /* Giới hạn chiều rộng tối đa */
        white-space: normal; /* Cho phép xuống dòng */
        word-wrap: break-word; /* Cho phép xuống dòng nếu từ quá dài */
        overflow-wrap: break-word; /* Tương thích với các trình duyệt khác */
        display: block; /* Đảm bảo phần tử có thể xuống dòng */
    }

</style>

<!-- JavaScript for handling View and Edit modals -->
<script>
    $(document).ready(function() {

      // Khi nhấn nút Edit mở modal, lấy shipping code và orderId, lưu vào nút Save
      $(".edit-btn").on("click", function () {
        const row = $(this).closest("tr");
        const shippingCode = row.find("td:nth-child(6) span").text().trim();

        // Đặt giá trị input modal
        $("#shipping-code-input").val(shippingCode === "N/A" ? "" : shippingCode);

        // Lưu orderId và rowIndex lên nút Save
        $("#save-shipping-code").data("orderId", row.data("orderId"));
        $("#save-shipping-code").data("rowIndex", row.index() + 1);
      });

      // Xử lý nút Save modal
      $("#save-shipping-code").on("click", function () {
        const newShippingCode = $("#shipping-code-input").val().trim();
        const orderId = $(this).data("orderId");
        const rowIndex = $(this).data("rowIndex");

        if (!newShippingCode) {
          alert("Mã vận chuyển không được để trống.");
          return;
        }

        const row = $(`table tbody tr:nth-child(${rowIndex})`);
        const $input = $("#shipping-code-input");

        updateShippingCode(orderId, newShippingCode, $input, row);
      });

      function updateShippingCode(orderId, shippingCode, $input, $row) {
        console.log('Gửi AJAX request: orderId=', orderId, 'shippingCode=', shippingCode);

        $.ajax({
          url: '/Admin/UpdateShippingCode',
          type: 'POST',
          data: {
            orderId: orderId,
            shippingCode: shippingCode
          },
          headers: {
            'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
          },
              success: function(response) {
      console.log('AJAX success:', response);
      if (response.success) {
        $row.find('td:nth-child(6) span').text(shippingCode);

         const statusTd = $row.find('td:nth-child(4) span');
        statusTd.text("Da giao hang");  // Đặt trực tiếp giá trị là "Đã giao hàng"

        // Cập nhật màu badge thành màu xanh (bg-gradient-success) vì trạng thái đã giao
        statusTd.removeClass("bg-gradient-secondary").addClass("bg-gradient-success");

        Swal.fire({
          title: 'Thành công',
          text: 'Cập nhật mã vận chuyển thành công!',
          icon: 'success',
          confirmButtonText: 'Đóng'
        }).then(() => {
          // Ẩn modal sau khi bấm Đóng
          const modalEl = document.getElementById('editModal');
          let modal = bootstrap.Modal.getInstance(modalEl);
          if (!modal) {
            modal = new bootstrap.Modal(modalEl);
          }
          modal.hide();
        });

      } else {
        console.log('Lỗi từ server:', response.message);
        Swal.fire({
          title: 'Lỗi',
          text: response.message || 'Cập nhật không thành công',
          icon: 'error',
          confirmButtonText: 'Đóng'
        }).then(() => {
          // Ẩn modal sau khi bấm Đóng
          const modalEl = document.getElementById('editModal');
          let modal = bootstrap.Modal.getInstance(modalEl);
          if (!modal) {
            modal = new bootstrap.Modal(modalEl);
          }
          modal.hide();
        });
        $input.val($input.data('original-value') || '');
      }
    }
    ,
          error: function(xhr, status, error) {
            console.error('AJAX error:', status, error, xhr.responseText);
            alert("Có lỗi xảy ra khi cập nhật mã vận chuyển.");
            $input.val($input.data('original-value') || '');
          }
        });
      }

    });
</script>

