@model BusinessLogicLayer.Dtos.ContactDtos.ContactMessageCreateDto

<body class="template-color-1">
    <div class="main-wrapper">
        <!-- Begin Hiraola's Breadcrumb Area -->
        <div class="breadcrumb-area">
            <div class="container">
                <div class="breadcrumb-content">
                    <h2>Liên Hệ</h2>
                    <ul>
                        <li><a href="/">Trang Chủ</a></li>
                        <li class="active">Liên Hệ</li>
                    </ul>
                </div>
            </div>
        </div>
        <!-- Hiraola's Breadcrumb Area End Here -->
        <!-- Begin Contact Main Page Area -->
        <div class="contact-main-page">
            <div class="container">
                <div class="row">
                    <div class="col-lg-5 offset-lg-1 col-md-12 order-1 order-lg-2">
                        <div class="contact-page-side-content">
                            <h3 class="contact-page-title">Liên Hệ Với Chúng Tôi</h3>
                            <p class="contact-page-message">
                                Chúng tôi luôn sẵn sàng lắng nghe ý kiến của bạn. Vui lòng liên hệ để được hỗ trợ hoặc gửi phản hồi về sản phẩm và dịch vụ của chúng tôi.
                            </p>
                            <div class="single-contact-block">
                                <h4><i class="fa fa-fax"></i> Địa Chỉ</h4>
                                <p>Lưu Hữu Phước Tân Lập, Đông Hoà, Dĩ An, Bình Dương</p>
                            </div>
                            <div class="single-contact-block">
                                <h4><i class="fa fa-phone"></i> Số Điện Thoại</h4>
                                <p>Di động: (034) 5492910</p>
                            </div>
                            <div class="single-contact-block last-child">
                                <h4><i class="fa fa-envelope-o"></i> Email</h4>
                                <p>huynhtrongnghia15n@gmail.com</p>
                                <p>ouroborus.free@gmail.com</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6 col-md-12 order-2 order-lg-1">
                        <div class="contact-form-content">
                            <h3 class="contact-page-title">Gửi Tin Nhắn Của Bạn</h3>
                            <div class="contact-form">
                                <form id="contact-form" asp-action="SendMessage" asp-controller="Contact" method="post">
                                    <div class="form-group">
                                        <label>Tên của bạn <span class="required">*</span></label>
                                        <input type="text" asp-for="Name" required>
                                        <span asp-validation-for="Name" class="text-danger"></span>
                                    </div>
                                    <div class="form-group">
                                        <label>Email của bạn <span class="required">*</span></label>
                                        <input type="email" asp-for="Email" required>
                                        <span asp-validation-for="Email" class="text-danger"></span>
                                    </div>
                                    <div class="form-group">
                                        <label>Chủ đề</label>
                                        <input type="text" asp-for="Subject">
                                        <span asp-validation-for="Subject" class="text-danger"></span>
                                    </div>
                                    <div class="form-group form-group-2">
                                        <label>Nội dung tin nhắn <span class="required">*</span></label>
                                        <textarea asp-for="Message" required></textarea>
                                        <span asp-validation-for="Message" class="text-danger"></span>
                                    </div>
                                    <div class="form-group">
                                        <!-- Widget reCAPTCHA -->
                                        <div class="g-recaptcha" data-sitekey="6LevClIrAAAAAPHgpjovd9NfDcIqU7t7drGXOFzK" data-callback="onRecaptchaSuccess"></div>
                                        <span id="recaptcha-error" class="text-danger"></span>
                                    </div>
                                    <div class="form-group">
                                        <button type="submit" class="hiraola-contact-form_btn" id="submit-btn" disabled>Gửi</button>
                                    </div>
                                </form>
                                <p class="form-message mt-3 mb-0" id="form-message"></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Contact Main Page Area End Here -->
    </div>

    @section Scripts {
        <!-- Thêm thư viện jQuery Validation -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.19.5/jquery.validate.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.19.5/additional-methods.min.js"></script>
        <script>
            // Callback khi reCAPTCHA được hoàn thành
            function onRecaptchaSuccess() {
                $('#submit-btn').prop('disabled', false);
                $('#recaptcha-error').text('');
            }

            $(document).ready(function () {
                // Khởi tạo validation cho form
                $('#contact-form').validate({
                    rules: {
                        Name: {
                            required: true,
                            minlength: 2
                        },
                        Email: {
                            required: true,
                            email: true
                        },
                        Message: {
                            required: true,
                            minlength: 10
                        }
                    },
                    messages: {
                        Name: {
                            required: "Vui lòng nhập tên của bạn.",
                            minlength: "Tên phải có ít nhất 2 ký tự."
                        },
                        Email: {
                            required: "Vui lòng nhập email của bạn.",
                            email: "Vui lòng nhập địa chỉ email hợp lệ."
                        },
                        Message: {
                            required: "Vui lòng nhập nội dung tin nhắn.",
                            minlength: "Nội dung tin nhắn phải có ít nhất 10 ký tự."
                        }
                    },
                    errorElement: "span",
                    errorClass: "text-danger",
                    errorPlacement: function (error, element) {
                        error.insertAfter(element);
                    }
                });

                $('#contact-form').on('submit', function (e) {
                    e.preventDefault();

                    // Kiểm tra validation client-side
                    if (!$(this).valid()) {
                        $('#form-message').text('Vui lòng kiểm tra lại các trường thông tin.').removeClass('text-success').addClass('text-danger');
                        return;
                    }

                    // Kiểm tra reCAPTCHA
                    var recaptchaResponse = grecaptcha.getResponse();
                    console.log('reCAPTCHA Response:', recaptchaResponse); // Debug giá trị token
                    if (!recaptchaResponse) {
                        $('#recaptcha-error').text('Vui lòng xác nhận bạn không phải là robot.');
                        $('#form-message').text('Vui lòng hoàn thành xác thực reCAPTCHA.').removeClass('text-success').addClass('text-danger');
                        return;
                    }
                    $('#recaptcha-error').text(''); // Xóa lỗi reCAPTCHA cũ

                    // Sử dụng FormData để gửi dữ liệu
                    var formData = new FormData(this);
                    formData.append('g-recaptcha-response', recaptchaResponse);

                    $.ajax({
                        url: $(this).attr('action'),
                        type: 'POST',
                        data: formData,
                        processData: false, // Không xử lý dữ liệu (cần cho FormData)
                        contentType: false, // Không đặt contentType (cần cho FormData)
                        headers: {
                            'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                        },
                        success: function (response) {
                            if (response.success) {
                                $('#form-message').text('Tin nhắn của bạn đã được gửi thành công!').removeClass('text-danger').addClass('text-success');
                                $('#contact-form')[0].reset();
                                grecaptcha.reset();
                                $('#submit-btn').prop('disabled', true); // Vô hiệu hóa nút sau khi gửi
                            } else {
                                $('#form-message').text(response.message).removeClass('text-success').addClass('text-danger');
                            }
                        },
                        error: function (xhr) {
                            var errorMessage = 'Đã có lỗi xảy ra. Vui lòng thử lại sau.';
                            if (xhr.responseJSON && xhr.responseJSON.message) {
                                errorMessage = xhr.responseJSON.message;
                            }
                            $('#form-message').text(errorMessage).removeClass('text-success').addClass('text-danger');
                        }
                    });
                });

                // Kiểm tra xem reCAPTCHA có tải đúng không
                if (typeof grecaptcha === 'undefined') {
                    $('#recaptcha-error').text('Không thể tải reCAPTCHA. Vui lòng kiểm tra kết nối mạng hoặc thử lại sau.');
                    $('#submit-btn').prop('disabled', true);
                } else {
                    // Đợi reCAPTCHA sẵn sàng
                    window.onload = function() {
                        if (typeof grecaptcha !== 'undefined' && grecaptcha.render) {
                            console.log('reCAPTCHA script loaded successfully.');
                        } else {
                            console.error('reCAPTCHA script failed to load.');
                        }
                    };
                }
            });
        </script>
    }
</body>