@model List<BusinessLogicLayer.Dtos.DesignDtos.DesignViewModel>

<body class="template-color-1">
    <div class="main-wrapper">
        <!-- Begin Hiraola's Breadcrumb Area -->
        <div class="breadcrumb-area">
            <div class="container">
                <div class="breadcrumb-content">
                    <h2>Cửa Hàng</h2>
                    <ul>
                        <li><a href="/Home/Index">Trang Chủ</a></li>
                        <li class="active">Sản Phẩm</li>
                    </ul>
                </div>
            </div>
        </div>
        <!-- Hiraola's Breadcrumb Area End Here -->
        <!-- Begin Hiraola's Content Wrapper Area -->
        <div class="hiraola-content_wrapper">
            <div class="container">
                <div class="row">
                    <div class="col-lg-3 order-2 order-lg-1">
                        <div class="hiraola-sidebar-catagories_area">
                            <div class="hiraola-sidebar_categories">
                                <div class="hiraola-categories_title">
                                    <h5>Tìm Kiếm Theo Giá</h5>
                                </div>
                                <div class="price-filter">
                                    <div class="price-inputs">
                                        <label><strong>Giá tối thiểu:</strong> </label>
                                        <div class="input-wrapper">
                                            <input type="number" id="minPrice" name="minPrice" placeholder="Giá tối thiểu" min="0" value="@ViewBag.MinPrice" />
                                            <span class="error-message" id="minPriceError"></span>
                                        </div>
                                        <label><strong>Giá tối đa:</strong> </label>
                                        <div class="input-wrapper">
                                            <input type="number" id="maxPrice" name="maxPrice" placeholder="Giá tối đa" min="0" value="@ViewBag.MaxPrice" />
                                            <span class="error-message" id="maxPriceError"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="category-module hiraola-sidebar_categories">
                                <div class="category-module_heading">
                                    <h5>Mẫu sản phẩm</h5>
                                </div>
                                <div class="module-body">
                                    <ul class="module-list_item">
                                        <li>
                                            <a href="javascript:void(0)" class="model-filter @(ViewBag.ModelId == null ? "active" : "")" data-model-id="">Tất cả</a>
                                            @if (ViewBag.ListModel != null)
                                            {
                                                foreach (var models in ViewBag.ListModel)
                                                {
                                                    <a href="javascript:void(0)" class="model-filter @(ViewBag.ModelId == models.ModelId ? "active" : "")" data-model-id="@models.ModelId">@models.ModelName</a>
                                                }
                                            }
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-9 order-1 order-lg-2">
                        <div class="shop-toolbar">
                            <div class="product-view-mode">
                                <a class="active grid-3"
                                   data-target="gridview-3"
                                   data-toggle="tooltip"
                                   data-placement="top"
                                   title="Grid View">
                                    <i class="fa fa-th"></i>
                                </a>
                                <a class="list"
                                   data-target="listview"
                                   data-toggle="tooltip"
                                   data-placement="top"
                                   title="List View">
                                    <i class="fa fa-th-list"></i>
                                </a>
                            </div>
                            <div class="product-item-selection_area">
                                <div class="product-short">
                                    <label class="select-label">Sắp xếp theo:</label>
                                    <select class="nice-select sort-filter">
                                        <option value="" selected="@(ViewBag.SortBy == null)">Tất cả</option>
                                        <option value="newest" selected="@(ViewBag.SortBy == "newest")">Mới nhất</option>
                                        <option value="bestselling" selected="@(ViewBag.SortBy == "bestselling")">Bán chạy</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="shop-product-wrap grid gridview-3 row">
                            @if (Model != null && Model.Any())
                            {
                                foreach (var item in Model)
                                {
                                    <div class="col-lg-4">
                                        <div class="slide-item">
                                            <div class="single_product">
                                                <div class="product-img">
                                                    <a asp-area="" asp-controller="Product" asp-action="ProductDetail" asp-route-designId="@item.DesignId">
                                                        <img class="primary-img"
                                                             src="@item.FirstImage.ImageUrl"
                                                             alt="Hiraola's Product Image" />
                                                        <img class="secondary-img"
                                                             src="@item.FirstImage.ImageUrl"
                                                             alt="Hiraola's Product Image" />
                                                    </a>
                                                </div>
                                                <div class="hiraola-product_content">
                                                    <div class="product-desc_info">
                                                        <h6>
                                                            <a class="product-name" asp-area="" asp-controller="Product" asp-action="ProductDetail"
                                                               asp-route-designId="@item.DesignId">@item.DesignName</a>
                                                        </h6>
                                                        <div class="price-box">
                                                            <span class="new-price">@item.Price VND</span>
                                                        </div>
                                                        <div class="rating-box">
                                                            <ul>
                                                                <li><i class="fa fa-star-of-david"></i></li>
                                                                <li><i class="fa fa-star-of-david"></i></li>
                                                                <li><i class="fa fa-star-of-david"></i></li>
                                                                <li><i class="fa fa-star-of-david"></i></li>
                                                                <li class="silver-color">
                                                                    <i class="fa fa-star"></i>
                                                                </li>
                                                            </ul>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="list-slide_item">
                                            <div class="single_product">
                                                <div class="product-img">
                                                    <a asp-area="" asp-controller="Product" asp-action="ProductDetail" asp-route-designId="@item.DesignId">
                                                        <img class="primary-img"
                                                             src="@item.FirstImage.ImageUrl"
                                                             alt="Hiraola's Product Image" />
                                                        <img class="secondary-img"
                                                             src="@item.FirstImage.ImageUrl"
                                                             alt="Hiraola's Product Image" />
                                                    </a>
                                                </div>
                                                <div class="hiraola-product_content">
                                                    <div class="product-desc_info">
                                                        <h6>
                                                            <a class="product-name" asp-area="" asp-controller="Product"
                                                               asp-action="ProductDetail" asp-route-designId="@item.DesignId">@item.DesignName</a>
                                                        </h6>
                                                        <div class="rating-box">
                                                            <ul>
                                                                <li><i class="fa fa-star-of-david"></i></li>
                                                                <li><i class="fa fa-star-of-david"></i></li>
                                                                <li><i class="fa fa-star-of-david"></i></li>
                                                                <li><i class="fa fa-star-of-david"></i></li>
                                                                <li class="silver-color">
                                                                    <i class="fa fa-star"></i>
                                                                </li>
                                                            </ul>
                                                        </div>
                                                        <div class="price-box">
                                                            <span class="new-price">@item.Price VND</span>
                                                        </div>
                                                        <div class="product-short_desc">
                                                            <p>@item.Description</p>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                }
                            }
                        </div>
                        <div class="row">
                            <div class="col-lg-12">
                                <div class="hiraola-paginatoin-area">
                                    <div class="row">
                                        <div class="col-lg-6 col-md-6 col-sm-6">
                                            <ul class="hiraola-pagination-box">
                                                @if (ViewBag.Page > 1)
                                                {
                                                    <li>
                                                        <a asp-action="ProductList"
                                                           asp-route-modelId="@ViewBag.ModelId"
                                                           asp-route-minPrice="@ViewBag.MinPrice"
                                                           asp-route-maxPrice="@ViewBag.MaxPrice"
                                                           asp-route-page="@(ViewBag.Page - 1)"
                                                           asp-route-pageSize="@ViewBag.PageSize"
                                                           asp-route-sortBy="@ViewBag.SortBy"
                                                           asp-route-searchQuery="@ViewBag.SearchQuery">
                                                            <i class="ion-ios-arrow-left"></i>
                                                        </a>
                                                    </li>
                                                }
                                                @for (var i = 1; i <= ViewBag.TotalPages; i++)
                                                {
                                                    <li class="@(i == ViewBag.Page ? "active" : "")">
                                                        <a asp-action="ProductList"
                                                           asp-route-modelId="@ViewBag.ModelId"
                                                           asp-route-minPrice="@ViewBag.MinPrice"
                                                           asp-route-maxPrice="@ViewBag.MaxPrice"
                                                           asp-route-page="@i"
                                                           asp-route-pageSize="@ViewBag.PageSize"
                                                           asp-route-sortBy="@ViewBag.SortBy"
                                                           asp-route-searchQuery="@ViewBag.SearchQuery">@i</a>
                                                    </li>
                                                }
                                                @if (ViewBag.Page < ViewBag.TotalPages)
                                                {
                                                    <li>
                                                        <a asp-action="ProductList"
                                                           asp-route-modelId="@ViewBag.ModelId"
                                                           asp-route-minPrice="@ViewBag.MinPrice"
                                                           asp-route-maxPrice="@ViewBag.MaxPrice"
                                                           asp-route-page="@(ViewBag.Page + 1)"
                                                           asp-route-pageSize="@ViewBag.PageSize"
                                                           asp-route-sortBy="@ViewBag.SortBy"
                                                           asp-route-searchQuery="@ViewBag.SearchQuery">
                                                            <i class="ion-ios-arrow-right"></i>
                                                        </a>
                                                    </li>
                                                }
                                            </ul>
                                        </div>
                                        <div class="col-lg-6 col-md-6 col-sm-6">
                                            <div class="product-select-box">
                                                <div class="product-short">
                                                    <p>(@(ViewBag.PageSize * (ViewBag.Page - 1) + 1) - @(Math.Min(ViewBag.PageSize * ViewBag.Page, ViewBag.TotalCount))) - (@ViewBag.TotalPages Trang)</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Thêm CSRF Token -->
    <form id="antiForgeryForm">
        @Html.AntiForgeryToken()
    </form>

    <!-- Thêm SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- CSS tùy chỉnh cho SweetAlert2 và nút ẩn -->
    <style>
        .swal2-popup {
            font-family: 'Lato', sans-serif;
            background: #f4f4f4;
            color: #595959;
            border: 1px solid #e5e5e5;
            border-radius: 8px;
        }

        .swal2-title {
            color: #333;
            font-size: 18px;
            font-weight: 700;
        }

        .swal2-content {
            color: #595959;
            font-size: 16px;
        }

        .swal2-confirm {
            background-color: #cda557 !important;
            color: #fff !important;
            border-radius: 3px !important;
            padding: 10px 20px !important;
            font-size: 12px !important;
            text-transform: uppercase !important;
            transition: all 0.3s ease-in !important;
        }

        .swal2-cancel {
            background-color: #595959 !important;
            color: #fff !important;
            border-radius: 3px !important;
            padding: 10px 20px !important;
            font-size: 12px !important;
            text-transform: uppercase !important;
            transition: all 0.3s ease-in !important;
        }

        .swal2-confirm:hover {
            background-color: #d5b473 !important;
        }

        .swal2-cancel:hover {
            background-color: #333 !important;
        }

        .swal2-icon.swal2-warning {
            color: #cda557 !important;
            border-color: #cda557 !important;
        }

        .swal2-icon.swal2-error {
            color: #ea3a3c !important;
            border-color: #ea3a3c !important;
        }

        /* Ẩn nút khi hết hàng */
        .out-of-stock .hiraola-add_cart {
            display: none !important;
        }
    </style>

    <script>
        function addToCart(designId, quantity, productType) {
            $.ajax({
                url: '/Cart/AddToCart',
                type: 'POST',
                data: {
                    designId: designId,
                    quantity: quantity,
                    productType: productType
                },
                headers: {
                    'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                },
                success: function (response) {
                    if (response.success) {
                        Swal.fire({
                            title: 'Thành công',
                            text: response.message,
                            icon: 'success',
                            confirmButtonText: 'Đóng',
                            customClass: {
                                confirmButton: 'swal2-confirm'
                            }
                        });
                        updateCartCount();
                        updateStockQuantity(designId);
                    } else {
                        Swal.fire({
                            title: 'Lỗi',
                            text: response.message,
                            icon: 'error',
                            confirmButtonText: 'Đóng',
                            customClass: {
                                confirmButton: 'swal2-confirm'
                            }
                        });
                    }
                },
                error: function (xhr) {
                    if (xhr.status === 401) {
                        Swal.fire({
                            title: 'Yêu cầu đăng nhập',
                            text: 'Vui lòng đăng nhập để thêm sản phẩm vào giỏ hàng.',
                            icon: 'warning',
                            showCancelButton: true,
                            confirmButtonText: 'Đăng nhập',
                            cancelButtonText: 'Đóng',
                            customClass: {
                                confirmButton: 'swal2-confirm',
                                cancelButton: 'swal2-cancel'
                            }
                        }).then((result) => {
                            if (result.isConfirmed) {
                                window.location.href = '/Auth/Register';
                            }
                        });
                    } else {
                        Swal.fire({
                            title: 'Lỗi',
                            text: 'Có lỗi xảy ra, vui lòng thử lại.',
                            icon: 'error',
                            confirmButtonText: 'Đóng',
                            customClass: {
                                confirmButton: 'swal2-confirm'
                            }
                        });
                    }
                }
            });
        }

        function updateCartCount() {
            $.ajax({
                url: '/Cart/GetCartItemCount',
                type: 'GET',
                success: function (response) {
                    if (response.success) {
                        $('#cart-count').text(response.count);
                    } else {
                        $('#cart-count').text('0');
                    }
                },
                error: function () {
                    $('#cart-count').text('0');
                }
            });
        }

        function updateStockQuantity(designId) {
            $.ajax({
                url: '/Product/GetStockQuantity',
                type: 'GET',
                data: { designId: designId },
                success: function (response) {
                    if (response.success) {
                        const addAction = $(`.add-actions[data-product-id="${designId}"]`);
                        if (response.stockQuantity === 0) {
                            addAction.addClass('out-of-stock');
                        } else {
                            addAction.removeClass('out-of-stock');
                        }
                    }
                },
                error: function () {
                    console.error('Không thể cập nhật trạng thái tồn kho.');
                }
            });
        }

        function initializeStockStatus() {
            $('.add-actions').each(function () {
                const designId = $(this).data('product-id');
                const stock = parseInt($(this).data('stock'));
                if (stock === 0) {
                    $(this).addClass('out-of-stock');
                }
            });
        }

        function filterProducts(modelId, sortBy, minPrice, maxPrice, page = 1, searchQuery = null) {
            $.ajax({
                url: '/Product/ProductList',
                type: 'GET',
                data: {
                    modelId: modelId,
                    minPrice: minPrice || $('#minPrice').val(),
                    maxPrice: maxPrice || $('#maxPrice').val(),
                    page: page,
                    pageSize: @ViewBag.PageSize,
                    sortBy: sortBy,
                    searchQuery: searchQuery
                },
                success: function (response) {
                    $('.shop-product-wrap').html($(response).find('.shop-product-wrap').html());
                    $('.hiraola-paginatoin-area').html($(response).find('.hiraola-paginatoin-area').html());
                    $('.model-filter').removeClass('active');
                    $(`.model-filter[data-model-id="${modelId || ''}"]`).addClass('active');
                    const url = new URL(window.location);
                    if (modelId) {
                        url.searchParams.set('modelId', modelId);
                    } else {
                        url.searchParams.delete('modelId');
                    }
                    if (sortBy) {
                        url.searchParams.set('sortBy', sortBy);
                    } else {
                        url.searchParams.delete('sortBy');
                    }
                    if (minPrice) {
                        url.searchParams.set('minPrice', minPrice);
                    } else {
                        url.searchParams.delete('minPrice');
                    }
                    if (maxPrice) {
                        url.searchParams.set('maxPrice', maxPrice);
                    } else {
                        url.searchParams.delete('maxPrice');
                    }
                    if (searchQuery) {
                        url.searchParams.set('searchQuery', searchQuery);
                    } else {
                        url.searchParams.delete('searchQuery');
                    }
                    url.searchParams.set('page', page);
                    window.history.pushState({}, '', url);
                    $('.nice-select').niceSelect('update');
                    initializeStockStatus();
                },
                error: function () {
                    Swal.fire({
                        title: 'Lỗi',
                        text: 'Không thể tải danh sách sản phẩm. Vui lòng thử lại.',
                        icon: 'error',
                        confirmButtonText: 'Đóng',
                        customClass: {
                            confirmButton: 'swal2-confirm'
                        }
                    });
                }
            });
        }

        $(document).ready(function () {
            updateCartCount();
            initializeStockStatus();

            // Hiển thị thông báo thanh toán thành công
            @if (TempData["SuccessMessage"] != null)
            {
                    <text>
                        Swal.fire({
                            title: 'Thành công',
                            text: '@TempData["SuccessMessage"]',
                            icon: 'success',
                            confirmButtonText: 'Đóng',
                            customClass: {
                                confirmButton: 'swal2-confirm'
                            }
                        });
                    </text>
            }

            $('.model-filter').on('click', function () {
                const modelId = $(this).data('model-id');
                const sortBy = $('.sort-filter').val();
                filterProducts(modelId, sortBy);
            });

            $('.sort-filter').on('change', function () {
                const sortBy = $(this).val();
                const modelId = $('.model-filter.active').data('model-id') || '';
                filterProducts(modelId, sortBy);
            });

            $('#minPrice, #maxPrice').on('change', function () {
                const minPrice = $('#minPrice').val();
                const maxPrice = $('#maxPrice').val();
                const modelId = $('.model-filter.active').data('model-id') || '';
                const sortBy = $('.sort-filter').val();
                filterProducts(modelId, sortBy, minPrice, maxPrice);
            });
        });
    </script>
</body>